                                                                                                                                                                                                                                                               
sap.ui.define(["sap/ui/core/mvc/Controller", "sap/ui/core/mvc/XMLView", "sap/ui/model/json/JSONModel", "sap/ui/core/BusyIndicator", "sap/m/MessageBox", "sap/m/MessageToast", "sap/ui/core/Fragment", "sap/m/BusyDialog",   "sap/ui/VersionInfo" ],            
function(Controller, XMLView, JSONModel, BusyIndicator, MessageBox, MessageToast, Fragment, mBusyDialog, VersionInfo ) {                                                                                                                                       
    "use strict";                                                                                                                                                                                                                                              
    return Controller.extend("z2ui5.controller.View1", {                                                                                                                                                                                                       
        async onAfterRendering() {                                                                                                                                                                                                                             
         try{                                                                                                                                                                                                                                                  
            if (!sap.z2ui5.oResponse.PARAMS) {                                                                                                                                                                                                                 
            BusyIndicator.hide();                                                                                                                                                                                                                              
                sap.z2ui5.isBusy = false;                                                                                                                                                                                                                      
                return;                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            const {S_POPUP, S_VIEW_NEST, S_VIEW_NEST2, S_POPOVER} = sap.z2ui5.oResponse.PARAMS;                                                                                                                                                                
            if (S_POPUP?.CHECK_DESTROY) {                                                                                                                                                                                                                      
                sap.z2ui5.oController.PopupDestroy();                                                                                                                                                                                                          
            }                                                                                                                                                                                                                                                  
            if (S_POPOVER?.CHECK_DESTROY) {                                                                                                                                                                                                                    
                sap.z2ui5.oController.PopoverDestroy();                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
            if (S_POPUP?.XML) {                                                                                                                                                                                                                                
                sap.z2ui5.oController.PopupDestroy();                                                                                                                                                                                                          
                await this.displayFragment(S_POPUP.XML, 'oViewPopup');                                                                                                                                                                                         
            }                                                                                                                                                                                                                                                  
            if (!sap.z2ui5.checkNestAfter) {                                                                                                                                                                                                                   
                if (S_VIEW_NEST?.XML) {                                                                                                                                                                                                                        
                    sap.z2ui5.oController.NestViewDestroy();                                                                                                                                                                                                   
                    await this.displayNestedView(S_VIEW_NEST.XML, 'oViewNest', 'S_VIEW_NEST');                                                                                                                                                                 
                    sap.z2ui5.checkNestAfter = true;                                                                                                                                                                                                           
                }                                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
            if (!sap.z2ui5.checkNestAfter2) {                                                                                                                                                                                                                  
                if (S_VIEW_NEST2?.XML) {                                                                                                                                                                                                                       
                    sap.z2ui5.oController.NestViewDestroy2();                                                                                                                                                                                                  
                    await this.displayNestedView2(S_VIEW_NEST2.XML, 'oViewNest2', 'S_VIEW_NEST2');                                                                                                                                                             
                    sap.z2ui5.checkNestAfter2 = true;                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
            if (S_POPOVER?.XML) {                                                                                                                                                                                                                              
                await this.displayPopover(S_POPOVER.XML, 'oViewPopover', S_POPOVER.OPEN_BY_ID);                                                                                                                                                                
            }                                                                                                                                                                                                                                                  
            BusyIndicator.hide();                                                                                                                                                                                                                              
            sap.z2ui5.isBusy = false;                                                                                                                                                                                                                          
            sap.z2ui5.onAfterRendering.forEach(item=>{                                                                                                                                                                                                         
                if (item !== undefined) {                                                                                                                                                                                                                      
                    item();                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
            )                                                                                                                                                                                                                                                  
           }catch(e){BusyIndicator.hide(); sap.z2ui5.isBusy = false; MessageBox.error( e.toLocaleString() , { title : "Unexpected Error Occured - App Terminated" , actions : [ ] , onClose :  () => {  new mBusyDialog({ text : "Please Restart the App"      
}).open();  } } ) }                                                                                                                                                                                                                                            
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        async displayFragment(xml, viewProp) {                                                                                                                                                                                                                 
            let oview_model = new JSONModel(sap.z2ui5.oResponse.OVIEWMODEL);                                                                                                                                                                                   
            const oFragment = await Fragment.load({                                                                                                                                                                                                            
                definition: xml,                                                                                                                                                                                                                               
                controller: sap.z2ui5.oControllerPopup,                                                                                                                                                                                                        
                id: "popupId"                                                                                                                                                                                                                                  
            });                                                                                                                                                                                                                                                
            oview_model.setSizeLimit(sap.z2ui5.JSON_MODEL_LIMIT);                                                                                                                                                                                              
            oFragment.setModel(oview_model);                                                                                                                                                                                                                   
            sap.z2ui5[viewProp] = oFragment;                                                                                                                                                                                                                   
            sap.z2ui5[viewProp].Fragment = Fragment;                                                                                                                                                                                                           
                oFragment.open();                                                                                                                                                                                                                              
        },                                                                                                                                                                                                                                                     
        async displayPopover(xml, viewProp, openById) {                                                                                                                                                                                                        
          // let sapUiCore = sap.ui.require('sap/ui/core/Core');                                                                                                                                                                                               
           sap.ui.require(["sap/ui/core/Element"], async function(Element) {                                                                                                                                                                                   
            const oFragment = await Fragment.load({                                                                                                                                                                                                            
                definition: xml,                                                                                                                                                                                                                               
                controller: sap.z2ui5.oControllerPopover,                                                                                                                                                                                                      
                 id: "popoverId"                                                                                                                                                                                                                               
            });                                                                                                                                                                                                                                                
            let oview_model = new JSONModel(sap.z2ui5.oResponse.OVIEWMODEL);                                                                                                                                                                                   
            oview_model.setSizeLimit(sap.z2ui5.JSON_MODEL_LIMIT);                                                                                                                                                                                              
            oFragment.setModel(oview_model);                                                                                                                                                                                                                   
            sap.z2ui5[viewProp] = oFragment;                                                                                                                                                                                                                   
            sap.z2ui5[viewProp].Fragment = Fragment;                                                                                                                                                                                                           
            let oControl = {};                                                                                                                                                                                                                                 
            if( sap.z2ui5.oView?.byId(openById) ) {                                                                                                                                                                                                            
              oControl = sap.z2ui5.oView.byId(openById);                                                                                                                                                                                                       
            } else if ( sap.z2ui5.oViewPopup?.Fragment.byId('popupId',openById) ) {                                                                                                                                                                            
              oControl = sap.z2ui5.oViewPopup.Fragment.byId('popupId',openById);                                                                                                                                                                               
            } else if ( sap.z2ui5.oViewNest?.byId(openById) ) {                                                                                                                                                                                                
              oControl = sap.z2ui5.oViewNest.byId(openById);                                                                                                                                                                                                   
            } else if ( sap.z2ui5.oViewNest2?.byId(openById) ) {                                                                                                                                                                                               
              oControl = sap.z2ui5.oViewNest2.byId(openById);                                                                                                                                                                                                  
            } else {                                                                                                                                                                                                                                           
               if(sapUiCore.byId(openById)) {                                                                                                                                                                                                                  
               //   oControl = sapUiCore.byId(openById);                                                                                                                                                                                                       
                  oControl = Element.getElementById(openById);                                                                                                                                                                                                 
                } else {                                                                                                                                                                                                                                       
                  oControl = null;                                                                                                                                                                                                                             
                };                                                                                                                                                                                                                                             
            }                                                                                                                                                                                                                                                  
             oFragment.openBy(oControl);                                                                                                                                                                                                                       
       }); },                                                                                                                                                                                                                                                  
        async displayNestedView(xml, viewProp, viewNestId) {                                                                                                                                                                                                   
            let oview_model = new JSONModel(sap.z2ui5.oResponse.OVIEWMODEL);                                                                                                                                                                                   
            const oView = await XMLView.create({                                                                                                                                                                                                               
                definition: xml,                                                                                                                                                                                                                               
                controller: sap.z2ui5.oControllerNest,                                                                                                                                                                                                         
                preprocessors: { xml: { models: { template: oview_model } } }                                                                                                                                                                                  
            });                                                                                                                                                                                                                                                
            oview_model.setSizeLimit(sap.z2ui5.JSON_MODEL_LIMIT);                                                                                                                                                                                              
            oView.setModel(oview_model);                                                                                                                                                                                                                       
            let oParent = sap.z2ui5.oView.byId(sap.z2ui5.oResponse.PARAMS[viewNestId].ID);                                                                                                                                                                     
            if (oParent) {                                                                                                                                                                                                                                     
                try {                                                                                                                                                                                                                                          
                    oParent[sap.z2ui5.oResponse.PARAMS[viewNestId].METHOD_DESTROY]();                                                                                                                                                                          
                } catch {}                                                                                                                                                                                                                                     
                oParent[sap.z2ui5.oResponse.PARAMS[viewNestId].METHOD_INSERT](oView);                                                                                                                                                                          
            }                                                                                                                                                                                                                                                  
            sap.z2ui5[viewProp] = oView;                                                                                                                                                                                                                       
        },                                                                                                                                                                                                                                                     
        async displayNestedView2(xml, viewProp, viewNestId) {                                                                                                                                                                                                  
            let oview_model = new JSONModel(sap.z2ui5.oResponse.OVIEWMODEL);                                                                                                                                                                                   
            const oView = await XMLView.create({                                                                                                                                                                                                               
                definition: xml,                                                                                                                                                                                                                               
                controller: sap.z2ui5.oControllerNest2,                                                                                                                                                                                                        
                preprocessors: { xml: { models: { template: oview_model } } }                                                                                                                                                                                  
            });                                                                                                                                                                                                                                                
            oview_model.setSizeLimit(sap.z2ui5.JSON_MODEL_LIMIT);                                                                                                                                                                                              
            oView.setModel(oview_model);                                                                                                                                                                                                                       
            let oParent = sap.z2ui5.oView.byId(sap.z2ui5.oResponse.PARAMS[viewNestId].ID);                                                                                                                                                                     
            if (oParent) {                                                                                                                                                                                                                                     
                try {                                                                                                                                                                                                                                          
                    oParent[sap.z2ui5.oResponse.PARAMS[viewNestId].METHOD_DESTROY]();                                                                                                                                                                          
                } catch {}                                                                                                                                                                                                                                     
                oParent[sap.z2ui5.oResponse.PARAMS[viewNestId].METHOD_INSERT](oView);                                                                                                                                                                          
            }                                                                                                                                                                                                                                                  
            sap.z2ui5[viewProp] = oView;                                                                                                                                                                                                                       
        },                                                                                                                                                                                                                                                     
        PopupDestroy() {                                                                                                                                                                                                                                       
            if (!sap.z2ui5.oViewPopup) {                                                                                                                                                                                                                       
                return;                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
            if (sap.z2ui5.oViewPopup.close) {                                                                                                                                                                                                                  
                try {                                                                                                                                                                                                                                          
                    sap.z2ui5.oViewPopup.close();                                                                                                                                                                                                              
                } catch {}                                                                                                                                                                                                                                     
            }                                                                                                                                                                                                                                                  
            sap.z2ui5.oViewPopup.destroy();                                                                                                                                                                                                                    
        },                                                                                                                                                                                                                                                     
        PopoverDestroy() {                                                                                                                                                                                                                                     
            if (!sap.z2ui5.oViewPopover) {                                                                                                                                                                                                                     
                return;                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
            if (sap.z2ui5.oViewPopover.close) {                                                                                                                                                                                                                
                try {                                                                                                                                                                                                                                          
                    sap.z2ui5.oViewPopover.close();                                                                                                                                                                                                            
                } catch {}                                                                                                                                                                                                                                     
            }                                                                                                                                                                                                                                                  
            sap.z2ui5.oViewPopover.destroy();                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
        NestViewDestroy() {                                                                                                                                                                                                                                    
            if (!sap.z2ui5.oViewNest) {                                                                                                                                                                                                                        
                return;                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
            sap.z2ui5.oViewNest.destroy();                                                                                                                                                                                                                     
        },                                                                                                                                                                                                                                                     
        NestViewDestroy2() {                                                                                                                                                                                                                                   
            if (!sap.z2ui5.oViewNest2) {                                                                                                                                                                                                                       
                return;                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
            sap.z2ui5.oViewNest2.destroy();                                                                                                                                                                                                                    
        },                                                                                                                                                                                                                                                     
        ViewDestroy() {                                                                                                                                                                                                                                        
            if (!sap.z2ui5.oView) {                                                                                                                                                                                                                            
                return;                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
            sap.z2ui5.oView.destroy();                                                                                                                                                                                                                         
        },                                                                                                                                                                                                                                                     
        eF(...args) {                                                                                                                                                                                                                                          
            sap.z2ui5.onBeforeEventFrontend.forEach(item => {                                                                                                                                                                                                  
                if (item !== undefined) {                                                                                                                                                                                                                      
                    item(args);                                                                                                                                                                                                                                
                }                                                                                                                                                                                                                                              
              }                                                                                                                                                                                                                                                
            )                                                                                                                                                                                                                                                  
            let oCrossAppNavigator;                                                                                                                                                                                                                            
            switch (args[0]) {                                                                                                                                                                                                                                 
            case 'DOWNLOAD_B64_FILE':                                                                                                                                                                                                                          
                var a = document.createElement("a");                                                                                                                                                                                                           
                a.href = args[1];                                                                                                                                                                                                                              
                a.download = args[2];                                                                                                                                                                                                                          
                a.click();                                                                                                                                                                                                                                     
                break;                                                                                                                                                                                                                                         
            case 'CROSS_APP_NAV_TO_PREV_APP':                                                                                                                                                                                                                  
                oCrossAppNavigator = sap.ushell.Container.getService("CrossApplicationNavigation");                                                                                                                                                            
                oCrossAppNavigator.backToPreviousApp();                                                                                                                                                                                                        
                break;                                                                                                                                                                                                                                         
            case 'CROSS_APP_NAV_TO_EXT':                                                                                                                                                                                                                       
                oCrossAppNavigator = sap.ushell.Container.getService("CrossApplicationNavigation");                                                                                                                                                            
                const hash = (oCrossAppNavigator.hrefForExternal({                                                                                                                                                                                             
                    target: args[1],                                                                                                                                                                                                                           
                    params: args[2]                                                                                                                                                                                                                            
                })) || "";                                                                                                                                                                                                                                     
                if (args[3] === 'EXT') {                                                                                                                                                                                                                       
                    let url = window.location.href.split('#')[0] + hash;                                                                                                                                                                                       
                    sap.m.URLHelper.redirect(url, true);                                                                                                                                                                                                       
                } else {                                                                                                                                                                                                                                       
                    oCrossAppNavigator.toExternal({                                                                                                                                                                                                            
                        target: {                                                                                                                                                                                                                              
                            shellHash: hash                                                                                                                                                                                                                    
                        }                                                                                                                                                                                                                                      
                    });                                                                                                                                                                                                                                        
                }                                                                                                                                                                                                                                              
                break;                                                                                                                                                                                                                                         
            case 'LOCATION_RELOAD':                                                                                                                                                                                                                            
                window.location = args[1];                                                                                                                                                                                                                     
                break;                                                                                                                                                                                                                                         
            case 'OPEN_NEW_TAB':                                                                                                                                                                                                                               
                window.open(args[1], '_blank');                                                                                                                                                                                                                
                break;                                                                                                                                                                                                                                         
            case 'POPUP_CLOSE':                                                                                                                                                                                                                                
                sap.z2ui5.oController.PopupDestroy();                                                                                                                                                                                                          
                break;                                                                                                                                                                                                                                         
            case 'POPOVER_CLOSE':                                                                                                                                                                                                                              
                sap.z2ui5.oController.PopoverDestroy();                                                                                                                                                                                                        
                break;                                                                                                                                                                                                                                         
            case 'NAV_CONTAINER_TO':                                                                                                                                                                                                                           
                var navCon = sap.z2ui5.oView.byId(args[1]);                                                                                                                                                                                                    
                var navConTo = sap.z2ui5.oView.byId(args[2]);                                                                                                                                                                                                  
                navCon.to(navConTo);                                                                                                                                                                                                                           
                break;                                                                                                                                                                                                                                         
            case 'NEST_NAV_CONTAINER_TO':                                                                                                                                                                                                                      
                navCon = sap.z2ui5.oViewNest.byId(args[1]);                                                                                                                                                                                                    
                navConTo = sap.z2ui5.oViewNest.byId(args[2]);                                                                                                                                                                                                  
                navCon.to(navConTo);                                                                                                                                                                                                                           
                break;                                                                                                                                                                                                                                         
            case 'NEST2_NAV_CONTAINER_TO':                                                                                                                                                                                                                     
                navCon = sap.z2ui5.oViewNest2.byId(args[1]);                                                                                                                                                                                                   
                navConTo = sap.z2ui5.oViewNest2.byId(args[2]);                                                                                                                                                                                                 
                navCon.to(navConTo);                                                                                                                                                                                                                           
                break;                                                                                                                                                                                                                                         
            case 'POPUP_NAV_CONTAINER_TO':                                                                                                                                                                                                                     
                navCon = Fragment.byId("popupId",args[1]);                                                                                                                                                                                                     
                navConTo = Fragment.byId("popupId",args[2]);                                                                                                                                                                                                   
                navCon.to(navConTo);                                                                                                                                                                                                                           
                break;                                                                                                                                                                                                                                         
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
        eB(...args) {                                                                                                                                                                                                                                          
            if (!window.navigator.onLine) {                                                                                                                                                                                                                    
                MessageBox.alert('No internet connection! Please reconnect to the server and try again.');                                                                                                                                                     
                return;                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
           if (sap.z2ui5.isBusy == true) {                                                                                                                                                                                                                     
             if (!args[0][2]) {                                                                                                                                                                                                                                
                   let oBusyDialog = new mBusyDialog();                                                                                                                                                                                                        
                   oBusyDialog.open();                                                                                                                                                                                                                         
                setTimeout( (oBusyDialog) => { oBusyDialog.close() } , 100 , oBusyDialog );                                                                                                                                                                    
                    return;                                                                                                                                                                                                                                    
                 }                                                                                                                                                                                                                                             
                }                                                                                                                                                                                                                                              
            sap.z2ui5.isBusy = true;                                                                                                                                                                                                                           
             BusyIndicator.show();                                                                                                                                                                                                                             
            sap.z2ui5.oBody = {};                                                                                                                                                                                                                              
            if ( args[0][3] ) {                                                                                                                                                                                                                                
                sap.z2ui5.oBody.XX = sap.z2ui5.oView.getModel().getData().XX;                                                                                                                                                                                  
                sap.z2ui5.oBody.VIEWNAME = 'MAIN';                                                                                                                                                                                                             
            }                                                                                                                                                                                                                                                  
            else if ( sap.z2ui5.oController == this ) {                                                                                                                                                                                                        
                sap.z2ui5.oBody.XX = sap.z2ui5.oView.getModel().getData().XX;                                                                                                                                                                                  
                sap.z2ui5.oBody.VIEWNAME = 'MAIN';                                                                                                                                                                                                             
            }else if                                                                                                                                                                                                                                           
               (  sap.z2ui5.oControllerPopup == this ) {                                                                                                                                                                                                       
                    if (sap.z2ui5.oViewPopup){                                                                                                                                                                                                                 
                    sap.z2ui5.oBody.XX = sap.z2ui5.oViewPopup.getModel().getData().XX;                                                                                                                                                                         
                   }                                                                                                                                                                                                                                           
                    sap.z2ui5.oBody.VIEWNAME = 'MAIN';                                                                                                                                                                                                         
                }else if (                                                                                                                                                                                                                                     
                sap.z2ui5.oControllerPopover == this ) {                                                                                                                                                                                                       
                            sap.z2ui5.oBody.XX = sap.z2ui5.oViewPopover.getModel().getData().XX;                                                                                                                                                               
                            sap.z2ui5.oBody.VIEWNAME = 'MAIN';                                                                                                                                                                                                 
                }else if (                                                                                                                                                                                                                                     
                sap.z2ui5.oControllerNest == this ) {                                                                                                                                                                                                          
                    sap.z2ui5.oBody.XX = sap.z2ui5.oViewNest.getModel().getData().XX;                                                                                                                                                                          
                    sap.z2ui5.oBody.VIEWNAME = 'NEST';                                                                                                                                                                                                         
                }else if (                                                                                                                                                                                                                                     
                sap.z2ui5.oControllerNest2 == this ) {                                                                                                                                                                                                         
                    sap.z2ui5.oBody.XX = sap.z2ui5.oViewNest2.getModel().getData().XX;                                                                                                                                                                         
                    sap.z2ui5.oBody.VIEWNAME = 'NEST2';                                                                                                                                                                                                        
                }                                                                                                                                                                                                                                              
            sap.z2ui5.onBeforeRoundtrip.forEach(item=>{                                                                                                                                                                                                        
                if (item !== undefined) {                                                                                                                                                                                                                      
                    item();                                                                                                                                                                                                                                    
                }})                                                                                                                                                                                                                                            
            if (args[0][1]) {                                                                                                                                                                                                                                  
                sap.z2ui5.oController.ViewDestroy();                                                                                                                                                                                                           
            }                                                                                                                                                                                                                                                  
            sap.z2ui5.oBody.ID = sap.z2ui5.oResponse.ID;                                                                                                                                                                                                       
            sap.z2ui5.oBody.ARGUMENTS = args;                                                                                                                                                                                                                  
                     sap.z2ui5.oBody.ARGUMENTS.forEach( ( item , i ) => {                                                                                                                                                                                      
    if ( i == 0 ) {  return; } if ( typeof item === 'object'  ){                                                                                                                                                                                               
      sap.z2ui5.oBody.ARGUMENTS[ i ] = JSON.stringify( item );                                                                                                                                                                                                 
     }                                                                                                                                                                                                                                                         
     });                                                                                                                                                                                                                                                       
            sap.z2ui5.oResponseOld = sap.z2ui5.oResponse;                                                                                                                                                                                                      
            sap.z2ui5.oController.Roundtrip();                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        responseError(response) {                                                                                                                                                                                                                              
            document.write(response);                                                                                                                                                                                                                          
        },                                                                                                                                                                                                                                                     
        updateModelIfRequired(paramKey, oView) {                                                                                                                                                                                                               
            if (sap.z2ui5.oResponse.PARAMS == undefined) { return; }                                                                                                                                                                                           
            if (sap.z2ui5.oResponse.PARAMS[paramKey]?.CHECK_UPDATE_MODEL) {                                                                                                                                                                                    
                let model = new JSONModel(sap.z2ui5.oResponse.OVIEWMODEL);                                                                                                                                                                                     
                model.setSizeLimit(sap.z2ui5.JSON_MODEL_LIMIT);                                                                                                                                                                                                
                if (oView) { oView.setModel(model); }                                                                                                                                                                                                          
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
        async responseSuccess(response) {                                                                                                                                                                                                                      
         try{                                                                                                                                                                                                                                                  
            sap.z2ui5.oResponse = response;                                                                                                                                                                                                                    
            if (sap.z2ui5.oResponse.PARAMS?.S_VIEW?.CHECK_DESTROY) {                                                                                                                                                                                           
                sap.z2ui5.oController.ViewDestroy();                                                                                                                                                                                                           
            };                                                                                                                                                                                                                                                 
            if(sap.z2ui5.oResponse.PARAMS?.S_FOLLOW_UP_ACTION?.CUSTOM_JS) {                                                                                                                                                                                    
              setTimeout(() => {                                                                                                                                                                                                                               
                  let mParams = sap.z2ui5.oResponse?.PARAMS.S_FOLLOW_UP_ACTION.CUSTOM_JS.split("'");                                                                                                                                                           
                  let mParamsEF = mParams.filter((val, index) => index % 2)                                                                                                                                                                                    
                  if(mParamsEF.length) {                                                                                                                                                                                                                       
                    sap.z2ui5.oController.eF.apply( undefined , mParamsEF);                                                                                                                                                                                    
                  } else {                                                                                                                                                                                                                                     
                    Function("return " + mParams[0])();                                                                                                                                                                                                        
                  }                                                                                                                                                                                                                                            
                },100);                                                                                                                                                                                                                                        
              };                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            sap.z2ui5.oController.showMessage('S_MSG_TOAST', sap.z2ui5.oResponse.PARAMS);                                                                                                                                                                      
            sap.z2ui5.oController.showMessage('S_MSG_BOX', sap.z2ui5.oResponse.PARAMS);                                                                                                                                                                        
            if (sap.z2ui5.oResponse.PARAMS?.S_VIEW?.XML) { if ( sap.z2ui5.oResponse.PARAMS?.S_VIEW?.XML !== '') {                                                                                                                                              
                sap.z2ui5.oController.ViewDestroy();                                                                                                                                                                                                           
               await sap.z2ui5.oController.createView(sap.z2ui5.oResponse.PARAMS.S_VIEW.XML, sap.z2ui5.oResponse.OVIEWMODEL);                                                                                                                                  
            return;  } }                                                                                                                                                                                                                                       
                this.updateModelIfRequired('S_VIEW', sap.z2ui5.oView);                                                                                                                                                                                         
                this.updateModelIfRequired('S_VIEW_NEST', sap.z2ui5.oViewNest);                                                                                                                                                                                
                this.updateModelIfRequired('S_VIEW_NEST2', sap.z2ui5.oViewNest2);                                                                                                                                                                              
                this.updateModelIfRequired('S_POPUP', sap.z2ui5.oViewPopup);                                                                                                                                                                                   
                this.updateModelIfRequired('S_POPOVER', sap.z2ui5.oViewPopover);                                                                                                                                                                               
                sap.z2ui5.oController.onAfterRendering();                                                                                                                                                                                                      
           }catch(e){BusyIndicator.hide(); if(e.message.includes("openui5")) { if(e.message.includes("script load error")) { sap.z2ui5.oController.checkSDKcompatibility(e) } } else {                                                                         
             MessageBox.error(e.toLocaleString()); } }                                                                                                                                                                                                         
        },                                                                                                                                                                                                                                                     
       async checkSDKcompatibility(err) {                                                                                                                                                                                                                      
          let oCurrentVersionInfo = await VersionInfo.load();                                                                                                                                                                                                  
          var ui5_sdk = oCurrentVersionInfo.gav.includes('com.sap.ui5') ? true : false;                                                                                                                                                                        
          if(!ui5_sdk) {                                                                                                                                                                                                                                       
            if(err) {                                                                                                                                                                                                                                          
              MessageBox.error("openui5 SDK is loaded, module: " + err._modules + " is not availabe in openui5" );                                                                                                                                             
              return;                                                                                                                                                                                                                                          
            };                                                                                                                                                                                                                                                 
          };                                                                                                                                                                                                                                                   
          MessageBox.error(err.toLocaleString());                                                                                                                                                                                                              
        },                                                                                                                                                                                                                                                     
        showMessage(msgType, params) {                                                                                                                                                                                                                         
            if (params == undefined) { return; }                                                                                                                                                                                                               
            if (params[msgType]?.TEXT !== undefined) {                                                                                                                                                                                                         
                if (msgType === 'S_MSG_TOAST') {                                                                                                                                                                                                               
                    MessageToast.show(params[msgType].TEXT,{duration: params[msgType].DURATION ? parseInt(params[msgType].DURATION) : 3000 ,                                                                                                                   
                                                            width: params[msgType].WIDTH ? params[msgType].WIDTH : '15em' ,                                                                                                                                    
                                                            onClose: params[msgType].ONCLOSE ? params[msgType].ONCLOSE : null ,                                                                                                                                
                                                            autoClose: params[msgType].AUTOCLOSE ? true : false ,                                                                                                                                              
                                                            animationTimingFunction: params[msgType].ANIMATIONTIMINGFUNCTION ? params[msgType].ANIMATIONTIMINGFUNCTION : 'ease' ,                                                                              
                                                            animationDuration: params[msgType].ANIMATIONDURATION ? parseInt(params[msgType].ANIMATIONDURATION) : 1000 ,                                                                                        
                                                            closeonBrowserNavigation: params[msgType].CLOSEONBROWSERNAVIGATION ? true : false                                                                                                                  
                     });                                                                                                                                                                                                                                       
                     if(params[msgType].CLASS) {                                                                                                                                                                                                               
                      let mtoast = {};                                                                                                                                                                                                                         
                      mtoast = document.getElementsByClassName("sapMMessageToast")[0];                                                                                                                                                                         
                      if(mtoast) { mtoast.classList.add(params[msgType].CLASS); }                                                                                                                                                                              
                     };                                                                                                                                                                                                                                        
                } else if (msgType === 'S_MSG_BOX') {                                                                                                                                                                                                          
                    if (params[msgType].TYPE) {                                                                                                                                                                                                                
                     MessageBox[params[msgType].TYPE](params[msgType].TEXT);                                                                                                                                                                                   
                    } else {                                                                                                                                                                                                                                   
                      MessageBox.show(params[msgType].TEXT,{styleClass:params[msgType].STYLECLASS ? params[msgType].STYLECLASS : '',                                                                                                                           
                                                                             title: params[msgType].TITLE ? params[msgType].TITLE : '',                                                                                                                        
                                                                             onClose: params[msgType].ONCLOSE ? Function("sAction", "return " + params[msgType].ONCLOSE) : null,                                                                               
                                                                             actions: params[msgType].ACTIONS ? params[msgType].ACTIONS : 'OK',                                                                                                                
                                                                             emphasizedAction: params[msgType].EMPHASIZEDACTION ? params[msgType].EMPHASIZEDACTION : 'OK',                                                                                     
                                                                             initialFocus: params[msgType].INITIALFOCUS ? params[msgType].INITIALFOCUS : null,                                                                                                 
                                                                             textDirection: params[msgType].TEXTDIRECTION ? params[msgType].TEXTDIRECTION : 'Inherit',                                                                                         
                                                                             icon: params[msgType].ICON ? params[msgType].ICON : 'NONE' ,                                                                                                                      
                                                                             details: params[msgType].DETAILS ? params[msgType].DETAILS : '',                                                                                                                  
                                                                             closeOnNavigation: params[msgType].CLOSEONNAVIGATION ? true : false                                                                                                               
                                                                          }                                                                                                                                                                                    
                                                    )                                                                                                                                                                                                          
                    }                                                                                                                                                                                                                                          
            }                                                                                                                                                                                                                                                  
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
        setApp(oApp){                                                                                                                                                                                                                                          
            this._oApp = oApp;                                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
        async createView(xml, viewModel) {                                                                                                                                                                                                                     
            let oview_model = new JSONModel(viewModel);                                                                                                                                                                                                        
            oview_model.setSizeLimit(sap.z2ui5.JSON_MODEL_LIMIT);                                                                                                                                                                                              
          sap.z2ui5.oView = await XMLView.create({                                                                                                                                                                                                             
                definition: xml,                                                                                                                                                                                                                               
                models: oview_model,                                                                                                                                                                                                                           
                controller: sap.z2ui5.oController,                                                                                                                                                                                                             
                id: 'mainView',                                                                                                                                                                                                                                
                preprocessors: { xml: { models: { template: oview_model } } }                                                                                                                                                                                  
            });                                                                                                                                                                                                                                                
            sap.z2ui5.oView.setModel(sap.z2ui5.oDeviceModel, "device");                                                                                                                                                                                        
            if (sap.z2ui5.oParent) {                                                                                                                                                                                                                           
                sap.z2ui5.oParent.removeAllPages();                                                                                                                                                                                                            
                sap.z2ui5.oParent.insertPage(sap.z2ui5.oView);                                                                                                                                                                                                 
            } else {                                                                                                                                                                                                                                           
                 this._oApp.byId("viewContainer").insertPage(sap.z2ui5.oView);                                                                                                                                                                                 
              //  this._oApp.byId("viewContainer").addItem(sap.z2ui5.oView);                                                                                                                                                                                   
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
        async readHttp() {                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
            const response = await fetch(sap.z2ui5.pathname, {                                                                                                                                                                                                 
                method: 'POST',                                                                                                                                                                                                                                
                headers: {                                                                                                                                                                                                                                     
                    'Content-Type': 'application/json',                                                                                                                                                                                                        
                    'sap-contextid-accept': 'header',                                                                                                                                                                                                          
                    'sap-contextid': sap.z2ui5.contextId                                                                                                                                                                                                       
                },                                                                                                                                                                                                                                             
                body: JSON.stringify(sap.z2ui5.oBody)                                                                                                                                                                                                          
            });                                                                                                                                                                                                                                                
            sap.z2ui5.contextId = response.headers.get("sap-contextid");                                                                                                                                                                                       
            if (!response.ok) {                                                                                                                                                                                                                                
                const responseText = await response.text();                                                                                                                                                                                                    
                sap.z2ui5.oController.responseError(responseText);                                                                                                                                                                                             
            } else {                                                                                                                                                                                                                                           
                const responseData = await response.json();                                                                                                                                                                                                    
                sap.z2ui5.responseData = responseData;                                                                                                                                                                                                         
                sap.z2ui5.oController.responseSuccess({                                                                                                                                                                                                        
                   ID : responseData.S_FRONT.ID,                                                                                                                                                                                                               
                   PARAMS : responseData.S_FRONT.PARAMS,                                                                                                                                                                                                       
                   OVIEWMODEL : responseData.MODEL,                                                                                                                                                                                                            
                 });                                                                                                                                                                                                                                           
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
        Roundtrip() {                                                                                                                                                                                                                                          
            sap.z2ui5.checkTimerActive = false;                                                                                                                                                                                                                
            sap.z2ui5.checkNestAfter = false;                                                                                                                                                                                                                  
            sap.z2ui5.checkNestAfter2 = false;                                                                                                                                                                                                                 
       let event =  (args) => { if ( args != undefined  ) { return args[0][0]; } };                                                                                                                                                                            
            sap.z2ui5.oBody.S_FRONT = {                                                                                                                                                                                                                        
                ID: sap.z2ui5?.oBody?.ID,                                                                                                                                                                                                                      
                COMPDATA: (sap.z2ui5.ComponentData) ? sap.z2ui5.ComponentData : {} ,                                                                                                                                                                           
                XX: sap.z2ui5?.oBody?.XX,                                                                                                                                                                                                                      
                ORIGIN: window.location.origin,                                                                                                                                                                                                                
                PATHNAME: window.location.pathname, // sap.z2ui5.pathname,                                                                                                                                                                                     
                SEARCH: (sap.z2ui5.search) ?  sap.z2ui5.search : window.location.search,                                                                                                                                                                       
                VIEW: sap.z2ui5.oBody?.VIEWNAME,                                                                                                                                                                                                               
                T_STARTUP_PARAMETERS: sap.z2ui5.startupParameters,                                                                                                                                                                                             
                   EVENT:  event(sap.z2ui5.oBody?.ARGUMENTS),                                                                                                                                                                                                  
            };                                                                                                                                                                                                                                                 
   if (  sap.z2ui5.oBody?.ARGUMENTS != undefined  ) { if ( sap.z2ui5.oBody?.ARGUMENTS.length > 0 ) { sap.z2ui5.oBody?.ARGUMENTS.shift(); } }                                                                                                                   
             sap.z2ui5.oBody.S_FRONT.T_EVENT_ARG = sap.z2ui5.oBody?.ARGUMENTS;                                                                                                                                                                                 
            delete sap.z2ui5.oBody.ID;                                                                                                                                                                                                                         
            delete sap.z2ui5.oBody?.VIEWNAME;                                                                                                                                                                                                                  
            delete sap.z2ui5.oBody?.S_FRONT.XX;                                                                                                                                                                                                                
            delete sap.z2ui5.oBody?.ARGUMENTS;                                                                                                                                                                                                                 
            if  (!sap.z2ui5.oBody.S_FRONT.T_EVENT_ARG) { delete sap.z2ui5.oBody.S_FRONT.T_EVENT_ARG; }                                                                                                                                                         
            if  (sap.z2ui5.oBody.S_FRONT.T_EVENT_ARG) { if (sap.z2ui5.oBody.S_FRONT.T_EVENT_ARG.length == 0 ) { delete sap.z2ui5.oBody.S_FRONT.T_EVENT_ARG; } }                                                                                                
            if  (sap.z2ui5.oBody.S_FRONT.T_STARTUP_PARAMETERS == undefined) { delete sap.z2ui5.oBody.S_FRONT.T_STARTUP_PARAMETERS; }                                                                                                                           
            if ( sap.z2ui5.oBody.S_FRONT.SEARCH == '' ){ delete sap.z2ui5.oBody.S_FRONT.SEARCH; }                                                                                                                                                              
            if (!sap.z2ui5.oBody.XX){ delete sap.z2ui5.oBody.XX; }                                                                                                                                                                                             
           sap.z2ui5.oController.readHttp();                                                                                                                                                                                                                   
        },                                                                                                                                                                                                                                                     
    })                                                                                                                                                                                                                                                         
});                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               